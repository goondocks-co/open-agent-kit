{
  "$schema": "https://raw.githubusercontent.com/anthropics/claude-code/main/schemas/hooks.json",
  "$comment": "Codebase Intelligence hooks for Claude Code. {{PORT}} is replaced with the project-specific daemon port. {{PROJECT_ROOT}} is replaced with the project directory. OAK hooks are identified by the /api/oak/ci/ URL pattern. Hook events are logged to .oak/ci/hooks.log for debugging.",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SAFE_INPUT=$(printf \"%s\" \"$INPUT\" | jq -c . 2>/dev/null || echo \"{}\"); HOOK_LOG=\"{{PROJECT_ROOT}}/.oak/ci/hooks.log\"; echo \"[SessionStart] $(date '+%Y-%m-%d %H:%M:%S') session_id=$(printf \"%s\" \"$SAFE_INPUT\" | jq -r '.session_id // .conversation_id // \"new\"') source=$(printf \"%s\" \"$SAFE_INPUT\" | jq -r '.source // \"startup\"')\" >> \"$HOOK_LOG\" 2>&1; (curl -sf http://localhost:{{PORT}}/api/health >/dev/null 2>&1 || oak ci start --quiet >/dev/null 2>&1 || true) && RESPONSE=$(printf \"%s\" \"$SAFE_INPUT\" | jq -c '{agent: \"claude\", session_id: (.session_id // .conversation_id), conversation_id: .conversation_id, source: .source, hook_origin: \"claude_config\", hook_event_name: \"SessionStart\", generation_id: .generation_id}' | curl -s -X POST http://localhost:{{PORT}}/api/oak/ci/session-start -H 'Content-Type: application/json' -d @- || true); echo \"$RESPONSE\" | tee -a \"$HOOK_LOG\" | jq -c 'if .context.injected_context then {hookSpecificOutput: {hookEventName: \"SessionStart\", additionalContext: .context.injected_context}} else {} end' 2>/dev/null || echo '{}'",
            "timeout": 30
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SAFE_INPUT=$(printf \"%s\" \"$INPUT\" | jq -c . 2>/dev/null || echo \"{}\"); RESPONSE=$(printf \"%s\" \"$SAFE_INPUT\" | jq -c '{agent: \"claude\", session_id: (.session_id // .conversation_id), conversation_id: .conversation_id, prompt: .prompt, hook_origin: \"claude_config\", hook_event_name: \"UserPromptSubmit\", generation_id: .generation_id}' | curl -s -X POST http://localhost:{{PORT}}/api/oak/ci/prompt-submit -H 'Content-Type: application/json' -d @- || true); echo \"$RESPONSE\" | jq -c 'if .context.injected_context then {hookSpecificOutput: {hookEventName: \"UserPromptSubmit\", additionalContext: .context.injected_context}} else {} end' 2>/dev/null || echo '{}'",
            "timeout": 15
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SAFE_INPUT=$(printf \"%s\" \"$INPUT\" | jq -c . 2>/dev/null || echo \"{}\"); RESPONSE=$(printf \"%s\" \"$SAFE_INPUT\" | jq -c '{agent: \"claude\", session_id: (.session_id // .conversation_id), conversation_id: .conversation_id, tool_name: .tool_name, tool_input: .tool_input, tool_output_b64: ((.tool_response // {}) | tostring | @base64), tool_use_id: .tool_use_id, hook_origin: \"claude_config\", hook_event_name: \"PostToolUse\", generation_id: .generation_id}' | curl -s -X POST http://localhost:{{PORT}}/api/oak/ci/post-tool-use -H 'Content-Type: application/json' -d @- || true); echo \"$RESPONSE\" | jq -c 'if .injected_context then {hookSpecificOutput: {hookEventName: \"PostToolUse\", additionalContext: .injected_context}} else {} end' 2>/dev/null || echo '{}'",
            "timeout": 5
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SAFE_INPUT=$(printf \"%s\" \"$INPUT\" | jq -c . 2>/dev/null || echo \"{}\"); printf \"%s\" \"$SAFE_INPUT\" | jq -c '{agent: \"claude\", session_id: (.session_id // .conversation_id), conversation_id: .conversation_id, hook_origin: \"claude_config\", hook_event_name: \"Stop\", generation_id: .generation_id}' | curl -s -X POST http://localhost:{{PORT}}/api/oak/ci/stop -H 'Content-Type: application/json' -d @- >/dev/null || true; echo '{}'",
            "timeout": 15
          }
        ]
      }
    ],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=$(cat); SAFE_INPUT=$(printf \"%s\" \"$INPUT\" | jq -c . 2>/dev/null || echo \"{}\"); HOOK_LOG=\"{{PROJECT_ROOT}}/.oak/ci/hooks.log\"; echo \"[SessionEnd] $(date '+%Y-%m-%d %H:%M:%S') session_id=$(printf \"%s\" \"$SAFE_INPUT\" | jq -r '.session_id // .conversation_id // \"unknown\"')\" >> \"$HOOK_LOG\" 2>&1; printf \"%s\" \"$SAFE_INPUT\" | jq -c '{agent: \"claude\", session_id: (.session_id // .conversation_id), conversation_id: .conversation_id, hook_origin: \"claude_config\", hook_event_name: \"SessionEnd\", generation_id: .generation_id}' | curl -s -X POST http://localhost:{{PORT}}/api/oak/ci/session-end -H 'Content-Type: application/json' -d @- >/dev/null || true; echo '' >> \"$HOOK_LOG\"; echo '{}'",
            "timeout": 15
          }
        ]
      }
    ]
  }
}
