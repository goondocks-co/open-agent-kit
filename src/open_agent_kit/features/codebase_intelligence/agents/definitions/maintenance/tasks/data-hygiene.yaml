# =============================================================================
# Built-in Task: Data Hygiene
# =============================================================================
# Task for: maintenance agent
#
# Analyzes memory store health, archives stale search entries, verifies
# ChromaDB/SQLite sync, and produces a health report.
#
# Output is captured in agent_runs.result — no files written to project.
# =============================================================================

name: data-hygiene
display_name: "Data Hygiene"
agent_type: maintenance
is_builtin: true
description: >
  Analyzes memory store health, archives old resolved/superseded
  observations from search index, verifies ChromaDB/SQLite sync,
  and reports on data integrity.

default_task: |
  Perform a data hygiene check on the project's memory store.
  Your output serves as the health report — it will be captured in the
  run record. Do NOT write any files.

  ## Phase 1 — Health Inventory

  Build a comprehensive health picture using CI tools:

  1. Use `ci_project_stats` to get baseline metrics:
     - Total code chunks indexed, unique files
     - Total memory/observation counts

  2. Use `ci_query` for detailed breakdowns:
     - Observations by status: `SELECT status, COUNT(*) FROM observations GROUP BY status`
     - Observations by type: `SELECT memory_type, COUNT(*) FROM observations GROUP BY memory_type`
     - Recent observation activity: `SELECT date(created_at) as day, COUNT(*) FROM observations
       WHERE created_at > date('now', '-30 days') GROUP BY day ORDER BY day DESC`
     - Session count: `SELECT COUNT(*) FROM sessions`
     - Average observations per session: `SELECT AVG(obs_count) FROM
       (SELECT session_id, COUNT(*) as obs_count FROM observations GROUP BY session_id)`

  Record all baseline numbers for the health report.

  ## Phase 2 — Archive Stale Search Entries

  Remove old resolved/superseded observations from the ChromaDB search index.
  These remain in SQLite as history but stop polluting vector search results.

  1. First, do a dry run to see the scope:
     - `ci_archive(status_filter="resolved", older_than_days=30, dry_run=true)`
     - `ci_archive(status_filter="superseded", older_than_days=14, dry_run=true)`

  2. Review the counts. If reasonable, proceed with actual archival:
     - `ci_archive(status_filter="resolved", older_than_days=30)`
     - `ci_archive(status_filter="superseded", older_than_days=14)`

  3. Record what was archived and why those thresholds were chosen:
     - Resolved observations older than 30 days: the fix is established
     - Superseded observations older than 14 days: the replacement is established

  ## Phase 3 — Sync Verification

  Check consistency between ChromaDB and SQLite:

  1. Get ChromaDB count from `ci_project_stats` (memory_count field)
  2. Get SQLite count: `SELECT COUNT(*) FROM observations WHERE embedded = 1`
  3. Compare the numbers:
     - If they match: sync is healthy
     - If ChromaDB > SQLite: possible orphans in ChromaDB
     - If SQLite > ChromaDB: possible missing embeddings
  4. Flag any discrepancies but do NOT attempt fixes — report only

  ## Phase 4 — Health Summary

  End with a structured health report. This is your final output and will
  be stored in the run record.

  Structure your report as:

  ### Memory Store Health
  - Total observations: N (active: N, resolved: N, superseded: N)
  - Observation types distribution: discovery: N, gotcha: N, etc.
  - Code chunks indexed: N across N files
  - Sessions tracked: N

  ### Archival Actions
  - Resolved observations archived: N (older than 30 days)
  - Superseded observations archived: N (older than 14 days)
  - Total removed from search index: N
  - These remain accessible via SQL queries

  ### Sync Status
  - ChromaDB observation count: N
  - SQLite embedded observation count: N
  - Status: IN SYNC / DRIFT DETECTED
  - Details of any discrepancies found

  ### Recommendations
  - List any issues that need manual attention
  - Suggest thresholds adjustments if observation volume is unusually high/low
  - Note any patterns in the data that suggest configuration changes

# Schedule: uncomment to enable periodic hygiene checks
# schedule:
#   cron: "0 4 * * WED"
#   description: "Weekly data hygiene check every Wednesday at 4 AM"

execution:
  timeout_seconds: 300
  max_turns: 50
  model: claude-sonnet-4-6

schema_version: 1
