# =============================================================================
# Built-in Task: Feature Documentation
# =============================================================================
# Task for: documentation agent
#
# Documents features by exploring CODE for implementation details, then
# enriching with CI memories for design rationale, gotchas, and context.
#
# To customize: Copy to oak/agents/feature-docs.yaml and modify as needed.
# =============================================================================

name: feature-docs
display_name: "Feature Documentation"
agent_type: documentation
is_builtin: true
description: >
  Discovers and documents all features in the codebase. Automatically finds
  undocumented features, checks for outdated docs, and creates/updates
  documentation enriched with CI memories for design rationale and gotchas.

default_task: |
  Discover and document all features in this codebase.

  ## 1. Discover Features (Automatic Discovery)

  **Find all features in the codebase:**
  - Use Glob: "src/**/features/*", "features/*", "**/feature_*"
  - Look for manifest.yaml files, __init__.py with exports, or feature directories
  - Use ci_search to find features mentioned in plans and memories
  - Check pyproject.toml or package.json for feature-related entry points

  **Build a feature inventory:**
  - List each feature found with its location
  - Note the feature's apparent purpose from code/comments

  ## 2. Check Existing Documentation

  **Find existing feature docs:**
  - Use Glob: "oak/docs/features/*.md", "oak/docs/*.md"
  - Read each doc file found

  **Categorize features:**
  - UNDOCUMENTED: Feature exists in code but no docs
  - OUTDATED: Docs exist but code has changed significantly
  - CURRENT: Docs exist and appear accurate

  **Prioritize work:**
  1. Undocumented features (CREATE new docs)
  2. Outdated docs (UPDATE existing)
  3. Skip features with current docs

  ## 3. For Each Feature Needing Documentation

  **Explore the implementation:**
  - Read main files: manifest.yaml, __init__.py, service.py, etc.
  - Find entry points, public API, key classes
  - Find configuration options and defaults
  - Identify dependencies on other features
  - Look for tests that demonstrate usage

  **Gather CI context:**
  - ci_search for original design plans
  - ci_memories(type="decision") for architectural rationale
  - ci_memories(type="gotcha") for warnings users need
  - ci_memories(type="discovery") for insights
  - Default to active observations only (omit `include_resolved`) — feature docs should reflect current state

  **Write documentation:**

  ```markdown
  # {Feature Name}

  {Description based on what the code actually does}

  ## How It Works

  {Explain the implementation - reference actual code paths}

  ## Configuration

  {Options found in code, with defaults and valid values}

  ## Usage Examples

  ```{language}
  // Example from actual codebase or tests
  ```

  ## Design Decisions

  - **{Decision}**: {Why from CI memories}

  ## Known Issues & Gotchas

  > ⚠️ **{Gotcha title}**: {Warning from CI memory}

  ## Related

  - [Implementation](../../src/path/to/feature.py:42)
  ```

  ## 4. Verify Everything
  - Code examples must exist in the codebase
  - Configuration options must match actual code
  - Don't document features that don't exist
  - All file paths in maintained_files are relative to project_root

  ## Reference: Good Feature Documentation

  ```markdown
  ## Email Processing

  The [`EmailProcessor`](src/services/email_processor.py) handles incoming mail
  parsing and classification for the brief generation system.

  ### How It Works

  1. Emails arrive via IMAP sync — [Initial email sync]({daemon_url}/activity/sessions/sync-uuid)
  2. The [`classify_email()`](src/services/email_processor.py:87) function
     determines email type based on subject and sender patterns

  ### Known Issues & Gotchas

  > **Gotcha**: Email classification can fail silently when the subject contains
  > special characters. Always validate `subject_line` before passing to the classifier.

  ### Design Decisions

  - **Synchronous processing**: Chosen because brief generation needs immediate
    access to email content. See the original plan for the full trade-off analysis.
  ```

# Execution limits (longer for thorough docs)
execution:
  timeout_seconds: 600
  max_turns: 100
  permission_mode: acceptEdits
  model: claude-sonnet-4-6

# Files this task maintains
maintained_files:
  - path: "{project_root}/oak/docs/features/*.md"
    purpose: "Feature documentation files"
    naming: "oak/docs/features/{feature_name}.md"
    auto_create: true

  - path: "{project_root}/oak/docs/*.md"
    purpose: "General documentation"
    auto_create: false

# CI queries to gather context (discovery mode - no specific feature filter)
ci_queries:
  discovery:
    - tool: ci_search
      query_template: "feature implementation"
      search_type: code
      min_confidence: medium
      limit: 20
      purpose: "Find feature implementations in the codebase"

    - tool: ci_search
      query_template: "feature design plan"
      search_type: plans
      min_confidence: medium
      limit: 15
      purpose: "Find feature design documents and plans"

  context:
    - tool: ci_memories
      filter: decision
      limit: 25
      purpose: "Find architectural decisions about features"

    - tool: ci_memories
      filter: gotcha
      limit: 20
      purpose: "Find warnings and pitfalls for features"

    - tool: ci_memories
      filter: discovery
      limit: 15
      purpose: "Find insights about feature implementations"

  verification:
    - tool: ci_sessions
      limit: 15
      include_summary: true
      purpose: "Find recent sessions about feature work"

# Output format
output_requirements:
  required_sections:
    - name: "Overview"
      source: "plans"
      description: "Feature purpose from design docs"
    - name: "How It Works"
      source: "code"
      description: "Implementation details"
    - name: "Known Issues & Gotchas"
      source: "memories"
      description: "Gotcha warnings - NEVER skip this section"
    - name: "Design Decisions"
      source: "memories"
      description: "Architectural rationale"
  link_sources: true

# Style preferences
style:
  tone: "technical"
  include_examples: true
  link_code_files: true
  code_link_format: "line"
  link_sessions: true
  conventions:
    - "Include code examples with syntax highlighting"
    - "Link to source files for all code references"
    - "Always include Gotchas section with warnings"
    - "Reference original plan/SDD for design rationale"

schema_version: 1
